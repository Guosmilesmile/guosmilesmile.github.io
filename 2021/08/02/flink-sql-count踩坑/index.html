<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Reference转自https://mp.weixin.qq.com/s/5XDkmuEIfHB_WsMHPeinkw 1.序篇通过本文你可了解到  踩坑场景篇-这个坑是啥样的 问题排查篇-坑的排查过程 问题原理解析篇-导致问题的机制是什么 避坑篇-如何避免这种问题 展望篇-有什么机制可以根本避免这种情况  先说下结论在非窗口类 flink sql 任务中，会存在 retract 机制，即上游会">
<meta property="og:type" content="article">
<meta property="og:title" content="flink sql count踩坑">
<meta property="og:url" content="http://yoursite.com/2021/08/02/flink-sql-count踩坑/index.html">
<meta property="og:site_name" content="Pray">
<meta property="og:description" content="Reference转自https://mp.weixin.qq.com/s/5XDkmuEIfHB_WsMHPeinkw 1.序篇通过本文你可了解到  踩坑场景篇-这个坑是啥样的 问题排查篇-坑的排查过程 问题原理解析篇-导致问题的机制是什么 避坑篇-如何避免这种问题 展望篇-有什么机制可以根本避免这种情况  先说下结论在非窗口类 flink sql 任务中，会存在 retract 机制，即上游会">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/167756F31262445DAFCAC5E409554D2E?method=download&shareKey=80b6b06f06cf5c5e1aa4be1aa4be845d">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/E3D26ED964D24FD7AA57BE7733D43EFB?method=download&shareKey=a65a7497eeae70d00132efcfae1be131">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/6544D0B99CCA47BABC6FBACDFB2EC35F?method=download&shareKey=8214f4abdef9a009d28907fcef291997">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/2D09CADD75814CE3BC90A77C8DAE50C0?method=download&shareKey=fcbe45a744070812d8e1a7ee3c401c7c">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/B27B316927EE4E62923CBF212DCB2808?method=download&shareKey=29ca4f660a8c87f2b3c298c779c632f1">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/41E23E453B0F44529C25B30B31245333?method=download&shareKey=96c49e4f68769f87086dc0b56061556f">
<meta property="og:updated_time" content="2021-08-02T14:41:47.661Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flink sql count踩坑">
<meta name="twitter:description" content="Reference转自https://mp.weixin.qq.com/s/5XDkmuEIfHB_WsMHPeinkw 1.序篇通过本文你可了解到  踩坑场景篇-这个坑是啥样的 问题排查篇-坑的排查过程 问题原理解析篇-导致问题的机制是什么 避坑篇-如何避免这种问题 展望篇-有什么机制可以根本避免这种情况  先说下结论在非窗口类 flink sql 任务中，会存在 retract 机制，即上游会">
<meta name="twitter:image" content="https://note.youdao.com/yws/api/personal/file/167756F31262445DAFCAC5E409554D2E?method=download&shareKey=80b6b06f06cf5c5e1aa4be1aa4be845d">






  <link rel="canonical" href="http://yoursite.com/2021/08/02/flink-sql-count踩坑/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>flink sql count踩坑 | Pray</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Pray</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">人肉排渣工程师,擅长排渣数据，服务器排渣</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/02/flink-sql-count踩坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="笑笑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/85E1A31B078749AAA5FBFA9FF57A0FCB?method=download&shareKey=312d566957926c021bfd2bf29d0fb19c#/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pray">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">flink sql count踩坑

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-08-02 22:41:27 / 修改时间：22:41:47" itemprop="dateCreated datePublished" datetime="2021-08-02T22:41:27+08:00">2021-08-02</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Flink/" itemprop="url" rel="index"><span itemprop="name">Flink</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>转自<a href="https://mp.weixin.qq.com/s/5XDkmuEIfHB_WsMHPeinkw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/5XDkmuEIfHB_WsMHPeinkw</a></p>
<h2 id="1-序篇"><a href="#1-序篇" class="headerlink" title="1.序篇"></a>1.序篇</h2><p>通过本文你可了解到</p>
<ul>
<li>踩坑场景篇-这个坑是啥样的</li>
<li>问题排查篇-坑的排查过程</li>
<li>问题原理解析篇-导致问题的机制是什么</li>
<li>避坑篇-如何避免这种问题</li>
<li>展望篇-有什么机制可以根本避免这种情况</li>
</ul>
<h4 id="先说下结论"><a href="#先说下结论" class="headerlink" title="先说下结论"></a>先说下结论</h4><p>在非窗口类 flink sql 任务中，会存在 retract 机制，即上游会向下游发送「撤回消息（做减法）」，<strong>最新的结果消息（做加法）</strong>两条消息来计算结果，保证结果正确性。</p>
<p>而如果我们在上下游中间使用了映射类 udf 改变了<strong>撤回消息（做减法）「的一些字段值时，就可能会导致」撤回消息（做减法）</strong>不能被正常处理，最终导致结果的错误。</p>
<h2 id="2-踩坑场景篇-这个坑是啥样的"><a href="#2-踩坑场景篇-这个坑是啥样的" class="headerlink" title="2.踩坑场景篇-这个坑是啥样的"></a>2.踩坑场景篇-这个坑是啥样的</h2><p>在介绍坑之前我们先介绍下我们的需求、实现方案的背景。</p>
<h3 id="2-1-背景"><a href="#2-1-背景" class="headerlink" title="2.1.背景"></a>2.1.背景</h3><p>在各类游戏中都会有一种场景，一个用户可以从 A 等级升级到 B 等级，用户可以不断的升级，但是一个用户同一时刻只会在同一个等级。需求指标就是当前分钟各个等级的用户数。</p>
<h3 id="2-2-预期效果"><a href="#2-2-预期效果" class="headerlink" title="2.2.预期效果"></a>2.2.预期效果</h3><p><img src="https://note.youdao.com/yws/api/personal/file/167756F31262445DAFCAC5E409554D2E?method=download&amp;shareKey=80b6b06f06cf5c5e1aa4be1aa4be845d" alt="image"></p>
<h3 id="2-3-解决思路"><a href="#2-3-解决思路" class="headerlink" title="2.3.解决思路"></a>2.3.解决思路</h3><ol>
<li>获取到当前所有用户的最新等级</li>
<li>一个用户同一时刻只会在一个等级，所以对每一个等级的用户做 count 操作</li>
</ol>
<h3 id="2-4-解决方案"><a href="#2-4-解决方案" class="headerlink" title="2.4.解决方案"></a>2.4.解决方案</h3><ol>
<li>获取到当前所有用户的最新等级：flink sql row_number() 就可以实现，按照数据的 rowtime 进行逆序排序就可以获取到用户当前最新的等级</li>
<li>对每一个等级的用户做 count 操作：对 row_number() 的后的明细结果进行 count 操作</li>
</ol>
<p>具体实现 sql 如下，非常简单：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> detail_tmp <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    等级,</span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">    <span class="string">`timestamp`</span></span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">      <span class="keyword">SELECT</span></span><br><span class="line">        等级,</span><br><span class="line">        <span class="keyword">id</span>,</span><br><span class="line">        <span class="string">`timestamp`</span>,</span><br><span class="line">        <span class="comment">-- row_number 获取最新状态</span></span><br><span class="line">        row_number() <span class="keyword">over</span>(</span><br><span class="line">          <span class="keyword">PARTITION</span> <span class="keyword">by</span> <span class="keyword">id</span></span><br><span class="line">          <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">            <span class="string">`timestamp`</span> <span class="keyword">DESC</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">        source_db.source_table</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">WHERE</span></span><br><span class="line">    rn = <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  DIM.中文等级 <span class="keyword">as</span> 等级,</span><br><span class="line">  <span class="keyword">sum</span>(part_uv) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">      等级,</span><br><span class="line">      <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">as</span> part_uv</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">      detail_tmp</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">      等级,</span><br><span class="line">      <span class="keyword">mod</span>(<span class="keyword">id</span>, <span class="number">1024</span>)</span><br><span class="line">  )</span><br><span class="line"><span class="comment">-- 上游数据的等级名称是数字，需求方要求给转换成中文，所以这里加了一个 udf 映射</span></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="keyword">LATERAL</span> <span class="keyword">TABLE</span>(等级中文映射_UDF(等级)) <span class="keyword">AS</span> DIM(中文等级) <span class="keyword">ON</span> <span class="literal">TRUE</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">  DIM.中文等级</span><br></pre></td></tr></table></figure></p>
<h3 id="2-4-2-参数配置"><a href="#2-4-2-参数配置" class="headerlink" title="2.4.2.参数配置"></a>2.4.2.参数配置</h3><p>使用 minibatch 参数方式控制数据输出频率。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">table.exec.mini-batch.enabled : true</span><br><span class="line">-- 设定 60s 的触发间隔</span><br><span class="line">table.exec.mini-batch.allow-latency : 60s</span><br><span class="line">table.exec.mini-batch.size : 10000000000</span><br></pre></td></tr></table></figure>
<p>任务 plan。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/E3D26ED964D24FD7AA57BE7733D43EFB?method=download&amp;shareKey=a65a7497eeae70d00132efcfae1be131" alt="image"></p>
<h3 id="2-5-问题场景"><a href="#2-5-问题场景" class="headerlink" title="2.5.问题场景"></a>2.5.问题场景</h3><p>这段 SQL 跑了 n 年都没有问题，但是有一天运营在配置【等级中文映射_UDF】时，不小心将一个等级的中文名给映射错了，虽然马上恢复了，但是当天的实时数据和离线数据对比后却发现，实时产出的数值比离线大很多！！！而之前都是保持一致的。</p>
<h2 id="3-问题排查篇-坑的排查过程"><a href="#3-问题排查篇-坑的排查过程" class="headerlink" title="3.问题排查篇-坑的排查过程"></a>3.问题排查篇-坑的排查过程</h2><p>首先我们想一下，这个指标是算 uv 的，运营将等级中文名配置错了，也应该是把原有等级的最终结果算少啊，怎么会算多呢？？？</p>
<p>然后我们将场景复现了下，来看看代码：</p>
<p>任务代码，大家可以直接 copy 到本地运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        EnvironmentSettings settings = EnvironmentSettings</span><br><span class="line">                .newInstance()</span><br><span class="line">                .useBlinkPlanner()</span><br><span class="line">                .inStreamingMode().build();</span><br><span class="line"></span><br><span class="line">        StreamTableEnvironment tEnv = StreamTableEnvironment.create(env, settings);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟输入</span></span><br><span class="line">        DataStream&lt;Tuple3&lt;String, Long, Long&gt;&gt; tuple3DataStream =</span><br><span class="line">                env.fromCollection(Arrays.asList(</span><br><span class="line">                        Tuple3.of(<span class="string">"2"</span>, <span class="number">1L</span>, <span class="number">1627218000000L</span>),</span><br><span class="line">                        Tuple3.of(<span class="string">"2"</span>, <span class="number">101L</span>, <span class="number">1627218000000L</span> + <span class="number">6000L</span>),</span><br><span class="line">                        Tuple3.of(<span class="string">"2"</span>, <span class="number">201L</span>, <span class="number">1627218000000L</span> + <span class="number">7000L</span>),</span><br><span class="line">                        Tuple3.of(<span class="string">"2"</span>, <span class="number">301L</span>, <span class="number">1627218000000L</span> + <span class="number">7000L</span>)));</span><br><span class="line">        <span class="comment">// 分桶取模 udf</span></span><br><span class="line">        tEnv.registerFunction(<span class="string">"mod"</span>, <span class="keyword">new</span> Mod_UDF());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 中文映射 udf</span></span><br><span class="line">        tEnv.registerFunction(<span class="string">"status_mapper"</span>, <span class="keyword">new</span> StatusMapper_UDF());</span><br><span class="line"></span><br><span class="line">        tEnv.createTemporaryView(<span class="string">"source_db.source_table"</span>, tuple3DataStream,</span><br><span class="line">                <span class="string">"status, id, timestamp"</span>);</span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">"WITH detail_tmp AS (\n"</span></span><br><span class="line">                + <span class="string">"  SELECT\n"</span></span><br><span class="line">                + <span class="string">"    status,\n"</span></span><br><span class="line">                + <span class="string">"    id,\n"</span></span><br><span class="line">                + <span class="string">"    `timestamp`\n"</span></span><br><span class="line">                + <span class="string">"  FROM\n"</span></span><br><span class="line">                + <span class="string">"    (\n"</span></span><br><span class="line">                + <span class="string">"      SELECT\n"</span></span><br><span class="line">                + <span class="string">"        status,\n"</span></span><br><span class="line">                + <span class="string">"        id,\n"</span></span><br><span class="line">                + <span class="string">"        `timestamp`,\n"</span></span><br><span class="line">                + <span class="string">"        row_number() over(\n"</span></span><br><span class="line">                + <span class="string">"          PARTITION by id\n"</span></span><br><span class="line">                + <span class="string">"          ORDER BY\n"</span></span><br><span class="line">                + <span class="string">"            `timestamp` DESC\n"</span></span><br><span class="line">                + <span class="string">"        ) AS rn\n"</span></span><br><span class="line">                + <span class="string">"      FROM source_db.source_table"</span></span><br><span class="line">                + <span class="string">"    )\n"</span></span><br><span class="line">                + <span class="string">"  WHERE\n"</span></span><br><span class="line">                + <span class="string">"    rn = 1\n"</span></span><br><span class="line">                + <span class="string">")\n"</span></span><br><span class="line">                + <span class="string">"SELECT\n"</span></span><br><span class="line">                + <span class="string">"  DIM.status_new as status,\n"</span></span><br><span class="line">                + <span class="string">"  sum(part_uv) as uv\n"</span></span><br><span class="line">                + <span class="string">"FROM\n"</span></span><br><span class="line">                + <span class="string">"  (\n"</span></span><br><span class="line">                + <span class="string">"    SELECT\n"</span></span><br><span class="line">                + <span class="string">"      status,\n"</span></span><br><span class="line">                + <span class="string">"      count(distinct id) as part_uv\n"</span></span><br><span class="line">                + <span class="string">"    FROM\n"</span></span><br><span class="line">                + <span class="string">"      detail_tmp\n"</span></span><br><span class="line">                + <span class="string">"    GROUP BY\n"</span></span><br><span class="line">                + <span class="string">"      status,\n"</span></span><br><span class="line">                + <span class="string">"      mod(id, 100)\n"</span></span><br><span class="line">                + <span class="string">"  )\n"</span></span><br><span class="line">                + <span class="string">"LEFT JOIN LATERAL TABLE(status_mapper(status)) AS DIM(status_new) ON TRUE\n"</span></span><br><span class="line">                + <span class="string">"GROUP BY\n"</span></span><br><span class="line">                + <span class="string">"  DIM.status_new"</span>;</span><br><span class="line"></span><br><span class="line">        Table result = tEnv.sqlQuery(sql);</span><br><span class="line"></span><br><span class="line">        tEnv.toRetractStream(result, Row.class).print();</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> UDF 代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusMapper_UDF</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eval</span><span class="params">(String status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status.equals(<span class="string">"1"</span>)) &#123;</span><br><span class="line">            collector.collect(<span class="string">"等级1"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status.equals(<span class="string">"2"</span>)) &#123;</span><br><span class="line">            collector.collect(<span class="string">"等级2"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status.equals(<span class="string">"3"</span>)) &#123;</span><br><span class="line">            collector.collect(<span class="string">"等级3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在正确情况（模拟 UDF 没有任何变动的情况下）的输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(true,等级2,1)</span><br><span class="line">(false,等级2,1)</span><br><span class="line">(true,等级2,2)</span><br><span class="line">(false,等级2,2)</span><br><span class="line">(true,等级2,3)</span><br><span class="line">(false,等级2,3)</span><br><span class="line">(true,等级2,4)</span><br></pre></td></tr></table></figure></p>
<p>最终等级2 的 uv 数为 4，结果复合预期✅。</p>
<p>模拟下用户修改了 udf 配置之后，UDF 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusMapper_UDF</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eval</span><span class="params">(String status)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">5</span>) &#123;</span><br><span class="line">            collect(<span class="string">"等级4"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"1"</span>.equals(status)) &#123;</span><br><span class="line">                collector.collect(<span class="string">"等级1"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"2"</span>.equals(status)) &#123;</span><br><span class="line">                collector.collect(<span class="string">"等级2"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"3"</span>.equals(status)) &#123;</span><br><span class="line">                collector.collect(<span class="string">"等级3"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(true,等级2,1)</span><br><span class="line">(false,等级2,1)</span><br><span class="line">(true,等级2,2)</span><br><span class="line">(false,等级2,2)</span><br><span class="line">(true,等级2,3)</span><br><span class="line">(false,等级2,3)</span><br><span class="line">(true,等级2,7)</span><br></pre></td></tr></table></figure>
<p>最终等级2 的 uv 数为 7，很明显这是错误结果❌。</p>
<p>因此可以确定是由于这个 UDF 的处理逻辑变换而导致的结果出现错误。</p>
<p>下文就让我们来分析下其中缘由。</p>
<h2 id="问题原理解析篇-导致问题的机制是什么"><a href="#问题原理解析篇-导致问题的机制是什么" class="headerlink" title="问题原理解析篇-导致问题的机制是什么"></a>问题原理解析篇-导致问题的机制是什么</h2><p>我们首先来分析下上述 SQL，可以发现整个 flink sql 任务是使用了 unbounded + minibatch 实现的，在 minibatch 触发条件触发时，上游算子会将之前的结果撤回，然后将最新的结果发出。</p>
<p>这个任务的 execution plan 如图所示。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/6544D0B99CCA47BABC6FBACDFB2EC35F?method=download&amp;shareKey=8214f4abdef9a009d28907fcef291997" alt="image"></p>
<p>可以从算子图中的一些计算逻辑可以看到，整个任务都是基于 retract 机制运行（count_retract、sum_retract 等）。</p>
<p>而涉及到 udf 的核心逻辑是在 Operator(ID = 7)，和 Operator(ID = 12) 之间。当 Operator(ID = 7) GroupAggregate 结果发生改变之后，会发一条「撤回消息（做减法）」，一条<strong>最新的结果消息（做加法）</strong>到 Operator(ID = 12) GroupAggregate。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/2D09CADD75814CE3BC90A77C8DAE50C0?method=download&amp;shareKey=fcbe45a744070812d8e1a7ee3c401c7c" alt="image"></p>
<blockquote>
<blockquote>
<p>Notes：简单解释下上面说的「撤回消息（做减法）」，「最新的结果消息（做加法）」。举个算 count 的例子：当整个任务的第一条数据来之后，之前没有数据，所以不用撤回，结果就是 0（没有数据） + 1（第一条数据） = 1（结果），当第二条结果来之后，就要将上次发的 1 消息（可以理解为是整个任务的一个中间结果）撤回，将最新的结果 2 发下去。那么计算方法就是 1（上次的结果） - 1（撤回） + 2（当前最新的结果消息）= 2（结果）。</p>
</blockquote>
</blockquote>
<p>通过算子图可以发现，【中文名称映射】UDF 是处于两个 GroupAggregate 之间的。也就是说 Operator(ID = 7) GroupAggregate 发出的「撤回消息（做减法）」，<strong>最新的结果消息（做加法）「都会执行这个 UDF，那么就有可能」撤回消息（做减法）「中的某个作为下游 GroupAggregate 算子 key 的字段会被更改成其他值，那么这条消息就不会发到原来下游 GroupAggregate 算子的原始 key 中，那么原来的 key 的历史结果就撤回不了了。。。但是」最新的结果消息（做加法）</strong>的字段没有被更改时，那么这个消息依然被发到了下游 GroupAggregate 算子，这就会导致没做减法，却做了加法，就会导致结果增加，如下图所示。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/B27B316927EE4E62923CBF212DCB2808?method=download&amp;shareKey=29ca4f660a8c87f2b3c298c779c632f1" alt="image"></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/41E23E453B0F44529C25B30B31245333?method=download&amp;shareKey=96c49e4f68769f87086dc0b56061556f" alt="image"></p>
<p>从这个角度出发，我们来分析下上面的 case，从内层发给外层的消息一条一条来分析。</p>
<p>内层消息怎么来看呢？其实就是将上面的 SQL 中的 left join 删除，重新跑一遍就可以得到结果，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(true,等级2,1)</span><br><span class="line">(false,等级2,1)</span><br><span class="line">(true,等级2,2)</span><br><span class="line">(false,等级2,2)</span><br><span class="line">(true,等级2,3)</span><br><span class="line">(false,等级4,3)</span><br><span class="line">(true,等级2,4)</span><br></pre></td></tr></table></figure>
<p>来分析下内层消息发出之后对应到外层消息的操作：</p>
<table>
<thead>
<tr>
<th>内层</th>
<th>外层</th>
</tr>
</thead>
<tbody>
<tr>
<td>(true,等级2,1)</td>
<td>(true,等级2,1)</td>
</tr>
<tr>
<td>(false,等级2,1)</td>
<td>(false,等级2,1)</td>
</tr>
<tr>
<td>(true,等级2,2)</td>
<td>(true,等级2,2)</td>
</tr>
<tr>
<td>(false,等级2,2)</td>
<td>(false,等级2,2)</td>
</tr>
<tr>
<td>(true,等级2,3)</td>
<td>(true,等级2,3)</td>
</tr>
</tbody>
</table>
<p>前五条消息不会导致错误，不用详细说明。</p>
<table>
<thead>
<tr>
<th>内层</th>
<th>外层</th>
</tr>
</thead>
<tbody>
<tr>
<td>(true,等级2,1)</td>
<td>(true,等级2,1)</td>
</tr>
<tr>
<td>(false,等级2,1)</td>
<td>(false,等级2,1)</td>
</tr>
<tr>
<td>(true,等级2,2)</td>
<td>(true,等级2,2)</td>
</tr>
<tr>
<td>(false,等级2,2)</td>
<td>(false,等级2,2)</td>
</tr>
<tr>
<td>(true,等级2,3)</td>
<td>(true,等级2,3)</td>
</tr>
</tbody>
</table>
<p>(false,等级4,3)</p>
<p>第六条消息发出之后，经过 udf 的处理之后，中文名被映射成了【等级4】，而其再通过 hash partition 策略向下发送消息时，就不能将这条撤回消息发到原本 key 为【等级2】的算子中了，这条撤回消息也无法被处理了。</p>
<table>
<thead>
<tr>
<th>内层</th>
<th>外层</th>
</tr>
</thead>
<tbody>
<tr>
<td>(true,等级2,1)</td>
<td>(true,等级2,1)</td>
</tr>
<tr>
<td>(false,等级2,1)</td>
<td>(false,等级2,1)</td>
</tr>
<tr>
<td>(true,等级2,2)</td>
<td>(true,等级2,2)</td>
</tr>
<tr>
<td>(false,等级2,2)</td>
<td>(false,等级2,2)</td>
</tr>
<tr>
<td>(true,等级2,3)</td>
<td>(true,等级2,3)</td>
</tr>
<tr>
<td>(false,等级4,3)</td>
<td></td>
</tr>
<tr>
<td>(true,等级2,4)</td>
<td>(false,等级2,3) (true,等级2,7)</td>
</tr>
</tbody>
</table>
<p>第七条消息 (true,等级2,4) 发出后，外层 GroupAggregate 算子首先会将上次发出的记过撤回，即(false,等级2,3)，然后将(true,等级2,4)累加到当前的记过上，即 3（上次结果）+ 4（这次最新的结果）= 7（结果）。就导致了上述的错误结果。</p>
<p>定位到问题原因之后，我们来看看怎么避免上述错误。</p>
<h2 id="6-避坑篇-如何避免这种问题"><a href="#6-避坑篇-如何避免这种问题" class="headerlink" title="6.避坑篇-如何避免这种问题"></a>6.避坑篇-如何避免这种问题</h2><h3 id="6-1-从源头避免"><a href="#6-1-从源头避免" class="headerlink" title="6.1.从源头避免"></a>6.1.从源头避免</h3><p>udf 这种映射维度的 udf 尽量在上线前就固定下来，避免后续更改造成的数据错误。</p>
<h3 id="6-2-替换为-ScalarFunction-进行映射"><a href="#6-2-替换为-ScalarFunction-进行映射" class="headerlink" title="6.2.替换为 ScalarFunction 进行映射"></a>6.2.替换为 ScalarFunction 进行映射</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WITH detail_tmp <span class="title">AS</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  SELECT</span></span></span><br><span class="line"><span class="function"><span class="params">    status,</span></span></span><br><span class="line"><span class="function"><span class="params">    id,</span></span></span><br><span class="line"><span class="function"><span class="params">    `timestamp`</span></span></span><br><span class="line"><span class="function"><span class="params">  FROM</span></span></span><br><span class="line"><span class="function"><span class="params">    (</span></span></span><br><span class="line"><span class="function"><span class="params">      SELECT</span></span></span><br><span class="line"><span class="function"><span class="params">        status,</span></span></span><br><span class="line"><span class="function"><span class="params">        id,</span></span></span><br><span class="line"><span class="function"><span class="params">        `timestamp`,</span></span></span><br><span class="line"><span class="function"><span class="params">        row_number()</span> <span class="title">over</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          PARTITION by id</span></span></span><br><span class="line"><span class="function"><span class="params">          ORDER BY</span></span></span><br><span class="line"><span class="function"><span class="params">            `timestamp` DESC</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span> AS rn</span></span><br><span class="line"><span class="function">      FROM</span></span><br><span class="line"><span class="function">        <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          SELECT</span></span></span><br><span class="line"><span class="function"><span class="params">            status,</span></span></span><br><span class="line"><span class="function"><span class="params">            id,</span></span></span><br><span class="line"><span class="function"><span class="params">            `timestamp`</span></span></span><br><span class="line"><span class="function"><span class="params">          FROM</span></span></span><br><span class="line"><span class="function"><span class="params">            source_db.source_table</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span> t1</span></span><br><span class="line"><span class="function">    ) t2</span></span><br><span class="line"><span class="function">  WHERE</span></span><br><span class="line"><span class="function">    rn </span>= <span class="number">1</span></span><br><span class="line">)</span><br><span class="line">SELECT</span><br><span class="line">  -- 在此处进行中文名称映射</span><br><span class="line">  等级中文映射_UDF(status) as status,</span><br><span class="line">  sum(part_uv) as uv</span><br><span class="line">FROM</span><br><span class="line">  (</span><br><span class="line">    SELECT</span><br><span class="line">      status,</span><br><span class="line">      count(distinct id) as part_uv</span><br><span class="line">    FROM</span><br><span class="line">      detail_tmp</span><br><span class="line">    GROUP BY</span><br><span class="line">      status,</span><br><span class="line">      mod(id, <span class="number">100</span>)</span><br><span class="line">  )</span><br><span class="line">GROUP BY</span><br><span class="line">  status</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusMapper_UDF</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">eval</span><span class="params">(String status)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">5</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"等级4"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"1"</span>.equals(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"等级1"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"2"</span>.equals(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"等级2"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"3"</span>.equals(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"等级3"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"未知"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是刚刚的逻辑，刚刚的配方，我们先来看一下结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(true,等级2,1)</span><br><span class="line">(false,等级2,1)</span><br><span class="line">(true,等级2,2)</span><br><span class="line">(false,等级2,2)</span><br><span class="line">(true,等级2,3)</span><br><span class="line">(false,等级4,3)</span><br><span class="line">(true,等级2,4)</span><br></pre></td></tr></table></figure>
<p>发现虽然依然会有 (false,等级4,3) 这样的错误撤回数据（这是 udf 决定的，没法避免），但是我们可以发现最终的结果是 (true,等级2,4)，结果依然是正确的。</p>
<p>再来分析下问什么这种方式可以解决，如图 plan。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/20/Kafka压缩的思考和性能对比/" rel="next" title="Kafka压缩的思考和性能对比">
                <i class="fa fa-chevron-left"></i> Kafka压缩的思考和性能对比
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/08/07/Flink-Kafka-Sink-埋坑历程/" rel="prev" title="Flink Kafka Sink 埋坑历程">
                Flink Kafka Sink 埋坑历程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://note.youdao.com/yws/api/personal/file/85E1A31B078749AAA5FBFA9FF57A0FCB?method=download&shareKey=312d566957926c021bfd2bf29d0fb19c#/images/avatar.gif" alt="笑笑">
            
              <p class="site-author-name" itemprop="name">笑笑</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">140</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">1.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-序篇"><span class="nav-number">2.</span> <span class="nav-text">1.序篇</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#先说下结论"><span class="nav-number">2.0.1.</span> <span class="nav-text">先说下结论</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#2-踩坑场景篇-这个坑是啥样的"><span class="nav-number">3.</span> <span class="nav-text">2.踩坑场景篇-这个坑是啥样的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-背景"><span class="nav-number">3.1.</span> <span class="nav-text">2.1.背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-预期效果"><span class="nav-number">3.2.</span> <span class="nav-text">2.2.预期效果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-解决思路"><span class="nav-number">3.3.</span> <span class="nav-text">2.3.解决思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-解决方案"><span class="nav-number">3.4.</span> <span class="nav-text">2.4.解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-参数配置"><span class="nav-number">3.5.</span> <span class="nav-text">2.4.2.参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-问题场景"><span class="nav-number">3.6.</span> <span class="nav-text">2.5.问题场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-问题排查篇-坑的排查过程"><span class="nav-number">4.</span> <span class="nav-text">3.问题排查篇-坑的排查过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题原理解析篇-导致问题的机制是什么"><span class="nav-number">5.</span> <span class="nav-text">问题原理解析篇-导致问题的机制是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-避坑篇-如何避免这种问题"><span class="nav-number">6.</span> <span class="nav-text">6.避坑篇-如何避免这种问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-从源头避免"><span class="nav-number">6.1.</span> <span class="nav-text">6.1.从源头避免</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-替换为-ScalarFunction-进行映射"><span class="nav-number">6.2.</span> <span class="nav-text">6.2.替换为 ScalarFunction 进行映射</span></a></li></ol></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">笑笑</span>

  

  
</div>

  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
